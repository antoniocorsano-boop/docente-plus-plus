<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PDF Import - Docente++</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 5px;
        }
        .test-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
        }
        .btn {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #d5f4e6;
            border-left: 4px solid #27ae60;
            border-radius: 4px;
        }
        .error {
            background-color: #fadbd8;
            border-left: 4px solid #e74c3c;
        }
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .activity-preview {
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }
        .class-group {
            margin: 15px 0;
        }
        .class-group h3 {
            color: #3498db;
            margin-bottom: 10px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Importazione Attivit√† da PDF</h1>
        
        <div class="test-section">
            <h2>üìã Test 1: Estrazione Testo da PDF</h2>
            <p>Carica un file PDF per testare l'estrazione del testo</p>
            <input type="file" id="pdfInput" accept=".pdf" class="test-input">
            <button class="btn" onclick="testPDFExtraction()">Testa Estrazione</button>
            <div id="extractionResult"></div>
        </div>

        <div class="test-section">
            <h2>üîç Test 2: Parsing Attivit√† da Testo</h2>
            <p>Incolla il testo di un piano didattico per testare il parser</p>
            <textarea id="textInput" class="test-input" rows="10" placeholder="Incolla qui il testo del piano didattico...

Esempio:
PRIMA MEDIA
- Lezione: Introduzione alla tecnologia
- Laboratorio: Uso degli strumenti
- Progetto: Realizzazione oggetto semplice

SECONDA MEDIA
- Lezione: Studio dei materiali
- Esercitazione: Calcoli tecnici
"></textarea>
            <button class="btn" onclick="testActivityParsing()">Testa Parser</button>
            <div id="parsingResult"></div>
        </div>

        <div class="test-section">
            <h2>üìä Test 3: Classificazione Tipo Attivit√†</h2>
            <p>Testa la classificazione automatica del tipo di attivit√†</p>
            <input type="text" id="activityInput" class="test-input" 
                   placeholder="Es: Lezione introduttiva sulla tecnologia">
            <button class="btn" onclick="testActivityClassification()">Classifica</button>
            <div id="classificationResult"></div>
        </div>
    </div>

    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        async function extractTextFromPDF(arrayBuffer) {
            try {
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }

                return fullText;
            } catch (error) {
                console.error('Error extracting text from PDF:', error);
                throw error;
            }
        }

        async function testPDFExtraction() {
            const input = document.getElementById('pdfInput');
            const resultDiv = document.getElementById('extractionResult');
            
            if (!input.files.length) {
                resultDiv.innerHTML = '<div class="result error">‚ö†Ô∏è Seleziona un file PDF</div>';
                return;
            }

            const file = input.files[0];
            resultDiv.innerHTML = '<div class="result">‚è≥ Estrazione in corso...</div>';

            try {
                const arrayBuffer = await file.arrayBuffer();
                const text = await extractTextFromPDF(arrayBuffer);
                
                resultDiv.innerHTML = `
                    <div class="result">
                        <strong>‚úÖ Testo estratto con successo!</strong>
                        <p>Lunghezza: ${text.length} caratteri</p>
                        <p>Anteprima primi 500 caratteri:</p>
                        <pre>${text.substring(0, 500)}...</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Errore: ${error.message}</div>`;
            }
        }

        function extractActivitiesFromText(textContent) {
            const activities = [];
            
            const classPatterns = {
                'Prima': /\b(?:prima|1[¬∞^¬™]|classe prima)\b/gi,
                'Seconda': /\b(?:seconda|2[¬∞^¬™]|classe seconda)\b/gi,
                'Terza': /\b(?:terza|3[¬∞^¬™]|classe terza)\b/gi
            };

            const sections = textContent.split(/\n\n+|\r\n\r\n+/);
            let currentClass = null;
            
            for (let section of sections) {
                section = section.trim();
                if (!section) continue;

                for (let [className, pattern] of Object.entries(classPatterns)) {
                    if (pattern.test(section)) {
                        currentClass = className;
                        break;
                    }
                }

                const activityPatterns = [
                    /(?:^|\n)\s*[-‚Ä¢¬∑]\s*(.+?)(?=\n|$)/gm,
                    /(?:^|\n)\s*\d+[.)]\s*(.+?)(?=\n|$)/gm,
                    /(?:lezione|laboratorio|esercitazione|progetto|verifica|compito):\s*(.+?)(?=\n|$)/gi,
                ];

                for (let pattern of activityPatterns) {
                    let match;
                    while ((match = pattern.exec(section)) !== null) {
                        const title = match[1].trim();
                        if (title && title.length > 10 && title.length < 200) {
                            activities.push({
                                title: title,
                                type: detectActivityType(title),
                                classLevel: currentClass || 'Generale',
                                status: 'planned'
                            });
                        }
                    }
                }
            }

            return activities;
        }

        function detectActivityType(text) {
            const lowerText = text.toLowerCase();
            
            if (lowerText.match(/\b(?:lezione|spiegazione|introduzione|teoria)\b/)) return 'lesson';
            if (lowerText.match(/\b(?:laboratorio|pratica|esperimento)\b/)) return 'lab';
            if (lowerText.match(/\b(?:esercitazione|esercizi|attivit√†)\b/)) return 'exercise';
            if (lowerText.match(/\b(?:progetto|elaborato)\b/)) return 'project';
            if (lowerText.match(/\b(?:compito|compiti|homework)\b/)) return 'homework';
            if (lowerText.match(/\b(?:verifica|test|esame|valutazione)\b/)) return 'exam';
            
            return 'lesson';
        }

        function testActivityParsing() {
            const input = document.getElementById('textInput');
            const resultDiv = document.getElementById('parsingResult');
            const text = input.value.trim();

            if (!text) {
                resultDiv.innerHTML = '<div class="result error">‚ö†Ô∏è Inserisci del testo</div>';
                return;
            }

            const activities = extractActivitiesFromText(text);
            
            if (activities.length === 0) {
                resultDiv.innerHTML = '<div class="result error">‚ö†Ô∏è Nessuna attivit√† trovata</div>';
                return;
            }

            // Group by class
            const grouped = {};
            activities.forEach(a => {
                if (!grouped[a.classLevel]) grouped[a.classLevel] = [];
                grouped[a.classLevel].push(a);
            });

            const typeIcons = {
                'lesson': 'üìö',
                'exercise': '‚úèÔ∏è',
                'lab': 'üî¨',
                'project': 'üìä',
                'homework': 'üìù',
                'exam': 'üìÑ'
            };

            let html = `<div class="result">
                <strong>‚úÖ Trovate ${activities.length} attivit√†!</strong>
            `;

            for (let [classLevel, acts] of Object.entries(grouped)) {
                html += `
                    <div class="class-group">
                        <h3>üìò ${classLevel} Media (${acts.length})</h3>
                        ${acts.map(a => `
                            <div class="activity-preview">
                                ${typeIcons[a.type] || 'üìã'} <strong>${a.title}</strong>
                                <br><small>Tipo: ${a.type} | Stato: ${a.status}</small>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            html += '</div>';
            resultDiv.innerHTML = html;
        }

        function testActivityClassification() {
            const input = document.getElementById('activityInput');
            const resultDiv = document.getElementById('classificationResult');
            const text = input.value.trim();

            if (!text) {
                resultDiv.innerHTML = '<div class="result error">‚ö†Ô∏è Inserisci il titolo di un\'attivit√†</div>';
                return;
            }

            const type = detectActivityType(text);
            
            const typeLabels = {
                'lesson': 'üìö Lezione',
                'exercise': '‚úèÔ∏è Esercitazione',
                'lab': 'üî¨ Laboratorio',
                'project': 'üìä Progetto',
                'homework': 'üìù Compiti',
                'exam': 'üìÑ Verifica'
            };

            resultDiv.innerHTML = `
                <div class="result">
                    <strong>‚úÖ Classificazione completata!</strong>
                    <p><strong>Titolo:</strong> ${text}</p>
                    <p><strong>Tipo identificato:</strong> ${typeLabels[type]}</p>
                    <p><strong>Codice tipo:</strong> <code>${type}</code></p>
                </div>
            `;
        }
    </script>
</body>
</html>
