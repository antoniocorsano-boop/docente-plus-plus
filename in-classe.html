<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interfaccia In Classe - Docente++">
    <meta name="theme-color" content="#4a90e2">
    <title>In Classe - Docente++</title>
    
    <!-- Material Design Icons -->
    <link href="fonts/material-icons.css" rel="stylesheet">
    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <!-- Roboto Font -->
    <link href="fonts/roboto.css" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    <!-- MD3 Theme Styles -->
    <link rel="stylesheet" href="src/styles/generated-md3-expressive.css">
    <link rel="stylesheet" href="src/styles/theme-md3-expressive.css">
    <link rel="stylesheet" href="src/styles/common-page.css">
    <link rel="stylesheet" href="css/in-classe.css">
    <link rel="stylesheet" href="css/schedule.css">
    <link rel="stylesheet" href="css/daily-timeline.css">
    <link rel="stylesheet" href="css/floating-assistant.css">
</head>
<body>
    <!-- Header with Lesson Info -->
    <header id="lesson-header" class="lesson-header">
        <div class="lesson-header-content">
            <button id="back-button" class="icon-btn" title="Torna all'orario" aria-label="Torna all'orario">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <div class="lesson-info">
                <h1 id="lesson-title">In Classe</h1>
                <div class="lesson-meta" id="lesson-meta" style="display: none;">
                    <span id="lesson-class"></span>
                    <span id="lesson-subject"></span>
                    <span id="lesson-datetime"></span>
                    <span id="lesson-type" class="activity-badge"></span>
                </div>
            </div>
            <button id="exit-button" class="btn btn-secondary" aria-label="Esci dalla classe">
                <span class="material-symbols-outlined">logout</span>
                <span class="btn-label">Esci</span>
            </button>
        </div>
    </header>

    <!-- Breadcrumb Navigation -->
    <nav class="navigation-bar" id="navigation-bar-in-classe" aria-label="Navigazione breadcrumb">
        <button id="breadcrumb-back-button" class="back-button" aria-label="Torna indietro" title="Torna indietro">
            <span class="material-symbols-outlined" aria-hidden="true">arrow_back</span>
            <span class="back-button-text">Indietro</span>
        </button>
        <div id="breadcrumb-container-in-classe" class="breadcrumb" aria-label="Percorso di navigazione">
            <a href="index.html" class="breadcrumb-link" onclick="window.location.href='index.html'; return false;">Home</a>
            <span class="breadcrumb-separator" aria-hidden="true">/</span>
            <a href="index.html#schedule" class="breadcrumb-link" onclick="window.location.href='index.html#schedule'; return false;">Orario</a>
            <span class="breadcrumb-separator" aria-hidden="true">/</span>
            <span class="breadcrumb-current" aria-current="page">In Classe</span>
        </div>
        <button id="breadcrumb-home-button" class="home-button" aria-label="Vai alla home" title="Vai alla home">
            <span class="material-symbols-outlined" aria-hidden="true">home</span>
            <span class="home-button-text">Home</span>
        </button>
    </nav>

    <!-- Lesson Picker Modal -->
    <div id="lesson-picker-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Seleziona Lezione</h2>
            <p>Scegli la lezione da gestire</p>
            <form id="lesson-picker-form">
                <div class="form-group">
                    <label for="lesson-picker-select">Lezione *</label>
                    <select id="lesson-picker-select" required>
                        <option value="">-- Seleziona una lezione --</option>
                    </select>
                    <p class="help-text">Seleziona una lezione dal tuo orario per entrare in classe</p>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <span class="material-symbols-outlined">login</span>
                        Entra in Classe
                    </button>
                    <button type="button" class="btn btn-secondary" id="lesson-picker-cancel">
                        Annulla
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <main id="in-classe-main" class="in-classe-main">
        <!-- Daily Timeline Widget -->
        <section class="daily-timeline-section" id="daily-timeline-section">
            <div class="daily-timeline-header">
                <h2>
                    <span class="material-symbols-outlined">schedule</span>
                    Orario di Oggi
                </h2>
                <span class="current-date" id="current-date-label"></span>
            </div>
            <div class="daily-timeline-container" id="daily-timeline-container">
                <!-- Daily lessons will be populated here -->
            </div>
        </section>
        
        <!-- Static Schedule Grid (Enhanced by schedule-enhance.js) -->
        <div class="schedule-table-wrapper" role="region" aria-label="Orario settimanale">
            <table id="static-schedule-grid" role="table" aria-label="Griglia orario settimanale">
                <thead>
                    <tr>
                        <th scope="col">Ora</th>
                        <th scope="col">Lunedì</th>
                        <th scope="col">Martedì</th>
                        <th scope="col">Mercoledì</th>
                        <th scope="col">Giovedì</th>
                        <th scope="col">Venerdì</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="schedule-time">08:00</td>
                        <td data-day="Lunedì" data-time="08:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Martedì" data-time="08:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Mercoledì" data-time="08:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Giovedì" data-time="08:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Venerdì" data-time="08:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                    </tr>
                    <tr>
                        <td class="schedule-time">09:00</td>
                        <td data-day="Lunedì" data-time="09:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Martedì" data-time="09:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Mercoledì" data-time="09:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Giovedì" data-time="09:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Venerdì" data-time="09:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                    </tr>
                    <tr>
                        <td class="schedule-time">10:00</td>
                        <td data-day="Lunedì" data-time="10:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Martedì" data-time="10:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Mercoledì" data-time="10:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Giovedì" data-time="10:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Venerdì" data-time="10:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                    </tr>
                    <tr>
                        <td class="schedule-time">11:00</td>
                        <td data-day="Lunedì" data-time="11:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Martedì" data-time="11:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Mercoledì" data-time="11:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Giovedì" data-time="11:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Venerdì" data-time="11:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                    </tr>
                    <tr>
                        <td class="schedule-time">12:00</td>
                        <td data-day="Lunedì" data-time="12:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Martedì" data-time="12:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Mercoledì" data-time="12:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Giovedì" data-time="12:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Venerdì" data-time="12:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                    </tr>
                    <tr>
                        <td class="schedule-time">13:00</td>
                        <td data-day="Lunedì" data-time="13:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Martedì" data-time="13:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Mercoledì" data-time="13:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Giovedì" data-time="13:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                        <td data-day="Venerdì" data-time="13:00" tabindex="-1"><span class="slot-placeholder">—</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Schedule Container -->
        <div id="schedule-container"></div>
        
        <!-- Daily Timeline Widget (shows lessons for the day) -->
        <aside id="daily-timeline-widget" class="daily-timeline-widget" role="complementary" aria-label="Orario del giorno">
            <div id="daily-timeline">
                <!-- Timeline will be rendered here by DailyTimeline.js -->
            </div>
        </aside>
        
        <!-- Activities Section -->
        <section class="collapsible-section" data-section="activities">
            <div class="section-header" role="button" tabindex="0" aria-expanded="true" aria-controls="activities-content">
                <div class="section-title">
                    <span class="material-symbols-outlined">assignment</span>
                    <h2>Attività</h2>
                    <span class="section-count" id="activities-count">0</span>
                </div>
                <span class="material-symbols-outlined expand-icon">expand_more</span>
            </div>
            <div class="section-content" id="activities-content">
                <div class="section-actions">
                    <button class="btn btn-primary" id="add-activity-btn">
                        <span class="material-symbols-outlined">add</span>
                        Nuova Attività
                    </button>
                </div>
                <div class="activities-list" id="activities-list">
                    <!-- Activities will be populated here -->
                </div>
            </div>
        </section>

        <!-- Homework Section -->
        <section class="collapsible-section" data-section="homework">
            <div class="section-header" role="button" tabindex="0" aria-expanded="true" aria-controls="homework-content">
                <div class="section-title">
                    <span class="material-symbols-outlined">book</span>
                    <h2>Compiti</h2>
                    <span class="section-count" id="homework-count">0</span>
                </div>
                <span class="material-symbols-outlined expand-icon">expand_more</span>
            </div>
            <div class="section-content" id="homework-content">
                <div class="section-actions">
                    <button class="btn btn-primary" id="add-homework-btn">
                        <span class="material-symbols-outlined">add</span>
                        Assegna Compito
                    </button>
                </div>
                <div class="homework-list" id="homework-list">
                    <!-- Homework will be populated here -->
                </div>
            </div>
        </section>

        <!-- Evaluations Section -->
        <section class="collapsible-section" data-section="evaluations">
            <div class="section-header" role="button" tabindex="0" aria-expanded="true" aria-controls="evaluations-content">
                <div class="section-title">
                    <span class="material-symbols-outlined">grade</span>
                    <h2>Valutazioni</h2>
                    <span class="section-count" id="evaluations-count">0</span>
                </div>
                <span class="material-symbols-outlined expand-icon">expand_more</span>
            </div>
            <div class="section-content" id="evaluations-content">
                <div class="students-evaluation-grid" id="students-evaluation-grid">
                    <!-- Students evaluation cards will be populated here -->
                </div>
            </div>
        </section>

        <!-- Voice Notes Section -->
        <section class="collapsible-section" data-section="voice-notes">
            <div class="section-header" role="button" tabindex="0" aria-expanded="true" aria-controls="voice-notes-content">
                <div class="section-title">
                    <span class="material-symbols-outlined">mic</span>
                    <h2>Appunto Vocale</h2>
                    <span class="ai-badge" title="Con trascrizione IA">AI</span>
                </div>
                <span class="material-symbols-outlined expand-icon">expand_more</span>
            </div>
            <div class="section-content" id="voice-notes-content">
                <div class="voice-recorder">
                    <div class="recording-controls">
                        <button class="btn btn-large btn-record" id="record-button" aria-label="Inizia registrazione">
                            <span class="material-symbols-outlined">mic</span>
                            <span class="btn-label">Registra</span>
                        </button>
                        <button class="btn btn-large btn-stop" id="stop-button" style="display: none;" aria-label="Ferma registrazione">
                            <span class="material-symbols-outlined">stop</span>
                            <span class="btn-label">Ferma</span>
                        </button>
                    </div>
                    <div class="recording-status" id="recording-status">
                        <span class="recording-indicator" style="display: none;">
                            <span class="pulse-dot"></span>
                            <span>Registrazione in corso...</span>
                        </span>
                        <span class="recording-time" id="recording-time">00:00</span>
                    </div>
                    <div class="audio-playback" id="audio-playback" style="display: none;">
                        <audio controls id="audio-player"></audio>
                    </div>
                    <div class="transcription-area" id="transcription-area" style="display: none;">
                        <h4>
                            <span class="material-symbols-outlined">text_snippet</span>
                            Trascrizione IA
                            <span class="badge-beta">DEMO</span>
                        </h4>
                        <div class="transcription-text" id="transcription-text">
                            <!-- AI transcription will appear here -->
                        </div>
                        <div class="transcription-actions">
                            <button class="btn btn-secondary" id="save-transcription-btn">
                                <span class="material-symbols-outlined">save</span>
                                Salva Trascrizione
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section class="collapsible-section" data-section="analytics">
            <div class="section-header" role="button" tabindex="0" aria-expanded="false" aria-controls="analytics-content">
                <div class="section-title">
                    <span class="material-symbols-outlined">analytics</span>
                    <h2>Analytics</h2>
                </div>
                <span class="material-symbols-outlined expand-icon">expand_more</span>
            </div>
            <div class="section-content" id="analytics-content" style="display: none;">
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h4>Presenze</h4>
                        <div class="chart-container">
                            <canvas id="attendance-chart"></canvas>
                        </div>
                        <div class="analytics-summary">
                            <span>Presenti: <strong id="present-count">0</strong></span>
                            <span>Assenti: <strong id="absent-count">0</strong></span>
                        </div>
                    </div>
                    <div class="analytics-card">
                        <h4>Performance Media</h4>
                        <div class="chart-container">
                            <canvas id="performance-chart"></canvas>
                        </div>
                        <div class="analytics-summary">
                            <span>Media Classe: <strong id="class-average">0</strong></span>
                        </div>
                    </div>
                    <div class="analytics-card full-width">
                        <h4>Andamento Generale</h4>
                        <div class="chart-container">
                            <canvas id="trend-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Agenda/Summary Section -->
        <section class="collapsible-section" data-section="summary">
            <div class="section-header" role="button" tabindex="0" aria-expanded="false" aria-controls="summary-content">
                <div class="section-title">
                    <span class="material-symbols-outlined">summarize</span>
                    <h2>Agenda e Sintesi</h2>
                </div>
                <span class="material-symbols-outlined expand-icon">expand_more</span>
            </div>
            <div class="section-content" id="summary-content" style="display: none;">
                <div class="summary-editor">
                    <h4>Sintesi Lezione</h4>
                    <textarea id="lesson-summary" rows="6" placeholder="Scrivi qui una sintesi della lezione di oggi..."></textarea>
                </div>
                <div class="next-steps">
                    <h4>Prossimi Passi</h4>
                    <div id="next-steps-list">
                        <!-- Next steps will be populated here -->
                    </div>
                    <button class="btn btn-secondary" id="add-next-step-btn">
                        <span class="material-symbols-outlined">add</span>
                        Aggiungi Passo
                    </button>
                </div>
                <div class="summary-actions">
                    <button class="btn btn-primary" id="save-summary-btn">
                        <span class="material-symbols-outlined">save</span>
                        Salva Sintesi
                    </button>
                    <button class="btn btn-secondary" id="export-summary-btn">
                        <span class="material-symbols-outlined">download</span>
                        Esporta PDF
                    </button>
                </div>
            </div>
        </section>

    </main>

    <!-- Modals -->
    
    <!-- Activity Modal -->
    <div id="activity-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Nuova Attività</h3>
            <form id="activity-form">
                <div class="form-group">
                    <label for="activity-title">Titolo *</label>
                    <input type="text" id="activity-title" required>
                </div>
                <div class="form-group">
                    <label for="activity-description">Descrizione</label>
                    <textarea id="activity-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="activity-type">Tipo</label>
                    <select id="activity-type">
                        <option value="lecture">Lezione</option>
                        <option value="exercise">Esercitazione</option>
                        <option value="discussion">Discussione</option>
                        <option value="lab">Laboratorio</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Salva</button>
                    <button type="button" class="btn btn-secondary modal-close">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Homework Modal -->
    <div id="homework-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Assegna Compito</h3>
            <form id="homework-form">
                <div class="form-group">
                    <label for="homework-title">Titolo *</label>
                    <input type="text" id="homework-title" required>
                </div>
                <div class="form-group">
                    <label for="homework-description">Descrizione</label>
                    <textarea id="homework-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="homework-due-date">Scadenza</label>
                    <input type="date" id="homework-due-date">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Assegna</button>
                    <button type="button" class="btn btn-secondary modal-close">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Evaluation Modal -->
    <div id="evaluation-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Valuta Studente</h3>
            <form id="evaluation-form">
                <div class="form-group">
                    <label for="student-name">Studente</label>
                    <input type="text" id="student-name" readonly>
                    <input type="hidden" id="student-id">
                </div>
                <div class="form-group">
                    <label for="evaluation-grade">Voto</label>
                    <input type="text" id="evaluation-grade" placeholder="es. 8, 9/10, Ottimo">
                </div>
                <div class="form-group">
                    <label for="evaluation-notes">Note</label>
                    <textarea id="evaluation-notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Salva</button>
                    <button type="button" class="btn btn-secondary modal-close">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/icons.js"></script>
    <script src="js/schedule-patch.js"></script>
    <script type="module">
        // Import centralized theme system
        import themeProvider from './src/components/ThemeProvider.js';
        import { validatePageTheme } from './src/utils/ThemeValidator.js';
        import { initializeTheme, setupThemePicker } from './js/theme.js';
        
        // Initialize ThemeProvider (centralized theme management)
        themeProvider.initialize();
        
        // Also initialize legacy theme system for backwards compatibility
        initializeTheme();
        
        // Validate theme setup
        validatePageTheme('in-classe');
        
        // Import floating assistant
        import { initFloatingAssistant } from './js/floating-assistant.js';
        window.initFloatingAssistant = initFloatingAssistant;
        
        // Import and initialize DailyTimeline
        import { initDailyTimeline } from './src/components/DailyTimeline.js';
        
        // Initialize DailyTimeline on page load
        document.addEventListener('DOMContentLoaded', () => {
            const timeline = initDailyTimeline('daily-timeline', new Date(), (lesson) => {
                console.log('Lesson clicked:', lesson);
                // Navigate to lesson if needed
                if (lesson.id) {
                    window.location.href = `in-classe.html?lesson=${encodeURIComponent(lesson.id)}`;
                }
            });
            window.dailyTimeline = timeline;
        });
        
        // Make themeProvider available globally for debugging
        window.themeProvider = themeProvider;
    </script>
    <script type="module" src="js/in-classe.js"></script>
    <script src="js/schedule-enhance.js"></script>

    <!-- AI Agent Floating Action Button (FAB) -->
    <button id="ai-fab" class="ai-fab" title="Apri Assistente IA" aria-label="Apri Assistente IA">
        <span class="material-symbols-outlined">smart_toy</span>
    </button>
</body>
</html>
